
#' Calculate and Summarize Distribution of Susceptibilities by _Rps_ Gene
#'
#' @description This function will calculate the distribution of
#' susceptibilities by _Rps_ gene.
#' @param x a `data.frame` containing the data.
#' @param cutoff value for percent susceptible cutoff. Numeric.
#' @param control value used to denote the susceptible control in the `Rps`
#'  field. Character.
#' @param sample field providing the unique identification for each sample being
#'  tested. Character.
#' @param Rps field providing the _Rps_ gene(s) being tested. Character.
#' @param perc_susc field providing the percent susceptible reactions.
#'  Character.
#'
#' @examples
#'
#' # locate system file for import
#' Ps <- system.file("extdata", "practice_data_set.csv", package = "hagis")
#'
#' # import 'practice_data_set.csv'
#' Ps <- read.csv(Ps)
#' head(Ps)
#'
#' # calculate susceptibilities with a 60 % cutoff value
#'susc <- summarize_rps(x = Ps,
#'                      cutoff = 60,
#'                      control = "susceptible",
#'                      sample = "Isolate",
#'                      Rps = "Rps",
#'                      perc_susc = "perc.susc")
#' susc
#'
#' # plot susceptibilities
#' autoplot(susc, type = "percentage")
#'
#' @return  returns an object of [class()] `hagis.rps.summary`
#' An object of class `hagis.summaries` is a [data.table::data.table()]
#'  containing the following components fields
#'   \describe{
#'     \item{Rps}{the Rps gene}
#'     \item{N_susc}{the total number susceptible for a given _Rps_ gene in the
#'      `Rps` field}
#'     \item{percent_pathogenic}{the frequency with which an _Rps_ gene is
#'     pathogenic}
#'   }
#' @importFrom data.table ":="
#' @export summarize_rps

summarize_rps <- function(x,
                          cutoff,
                          control,
                          sample,
                          Rps,
                          perc_susc) {
  
  # check inptuts and rename fields to work with this package
  x <- .check_inputs(
    .x = x,
    .cutoff = cutoff,
    .control = control,
    .sample = sample,
    .Rps = Rps,
    .perc_susc = perc_susc
  )
  
  # CRAN NOTE avoidance
  susceptible.1 <- percent_pathogenic <- N_susc <- NULL
  
  # summarise the reactions, create susceptible.1 field, see
  # internal_functions.R
  x <- .binary_cutoff(.x = x, .cutoff = cutoff)
  
  # create new data.table with percentages
  y <- x[, list(N_susc = sum(susceptible.1)), by = list(Rps)]
  y[, percent_pathogenic := round((N_susc) / max(N_susc) * 100, 2)]
  
  # Set new class
  class(y) <- union("hagis.rps.summary", class(y))
  return(y)
}

#' @importFrom ggplot2 autoplot
#' @export
ggplot2::autoplot

#' Plot _Rps_ Gene Percent Pathogenic Summaries
#'
#' @description Creates a \pkg{ggplot2} object of the _Rps_ gene
#'  summaries calculated by [summarize_rps()]
#' @param object a `hagis.rps.summary` object generated by [summarize_rps()].
#'  Character.
#' @param type a vector of values for which the bar plot is desired. Specify
#'  whether to return a graph of the percent pathogenic isolates, `percentage`,
#'  or as the count, `count`. Character.
#' @param color a named or hexadecimal color value to use for the bar color
#' @param ... passed to the chosen `geom(s)`
#'
#' @examples
#  # locate system file for import
#' Ps <- system.file("extdata", "practice_data_set.csv", package = "hagis")
#'
#' # import 'practice_data_set.csv'
#' Ps <- read.csv(Ps)
#'
#' # calculate susceptibilities with a 60 % cutoff value
#' susc <- summarize_rps(x = Ps,
#'                        cutoff = 60,
#'                        control = "susceptible",
#'                        sample = "Isolate",
#'                        Rps = "Rps",
#'                        perc_susc = "perc.susc")
#'
#' # Visualize the summary of Rps genes
#' autoplot(susc, type = "percentage")
#' @method autoplot hagis.rps.summary
#' @return A \link[ggplot2]{ggplot2} plot
#' @export

autoplot.hagis.rps.summary <- function(object, type, color = NULL, ...) {
  # CRAN NOTE avoidance
  Rps <- percent_pathogenic <- NULL
  
  plot_percentage <- function(.data, .color) {
    perc_plot <- ggplot2::ggplot(data = .data,
                                 ggplot2::aes(x = as.factor(Rps),
                                              y = percent_pathogenic)) +
      ggplot2::labs(y = "Percent of samples",
                    x = ~ italic(Rps) ~ "gene") +
      ggplot2::ggtitle(expression("Percentage of samples pathogenic"))
    
    if (!is.null(.color)) {
      perc_plot +
        ggplot2::geom_col(fill = .color,
                          colour = .color)
    } else {
      perc_plot +
        ggplot2::geom_col()
    }
  }
  
  plot_count <- function(.data, .color) {
    N_susc <- NULL
    num_plot <- ggplot2::ggplot(data = .data,
                                ggplot2::aes(x = as.factor(Rps),
                                             y = N_susc)) +
      ggplot2::labs(y = "Number of samples",
                    x = ~ italic(Rps) ~ "gene") +
      ggplot2::ggtitle(expression("Number of samples pathogenic"))
    
    if (!is.null(.color)) {
      num_plot +
        ggplot2::geom_col(fill = .color,
                          colour = .color)
    } else {
      num_plot +
        ggplot2::geom_col()
    }
  }
  
  if (type == "percentage") {
    plot_percentage(.data = object, .color = color)
  } else if (type == "count") {
    plot_count(.data = object, .color = color)
  } else 
    stop(.call = FALSE,
         "You have entered an invalid `type`.")
  }
  